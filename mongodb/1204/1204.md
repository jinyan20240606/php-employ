# <a name="_toc451356795"></a><a name="_toc476842566"></a><a name="_toc484877582"></a><a name="_toc531708784"></a>**Nosql数据库-mongodb**

- [**Nosql数据库-mongodb**](#nosql数据库-mongodb)
- [**一、mongodb的认识**](#一mongodb的认识)
  - [**1、基本简介**](#1基本简介)
  - [**2、mongodb与 mysql性能比较**](#2mongodb与-mysql性能比较)
  - [**3、应用范围和限制**](#3应用范围和限制)
- [**二、需要掌握的几个概念**](#二需要掌握的几个概念)
  - [**1、文档**](#1文档)
  - [**2、集合**](#2集合)
  - [**3、数据库**](#3数据库)
  - [**4、mongodb的数据体系**](#4mongodb的数据体系)
- [**三、安装mongodb**](#三安装mongodb)
- [**四、入门语句**](#四入门语句)
  - [**1、创建数据库**](#1创建数据库)
  - [**2、查看数据库，**](#2查看数据库)
  - [**3、创建集合**](#3创建集合)
  - [**4、查看集合**](#4查看集合)
  - [**5、查询集合里面的文档**](#5查询集合里面的文档)
  - [**6、删除集合**](#6删除集合)
  - [**7、删除数据库**](#7删除数据库)
  - [**8、帮助命令**](#8帮助命令)
- [**五、增删改查操作**](#五增删改查操作)
  - [**1、添加文档**](#1添加文档)
  - [**2、删除文档**](#2删除文档)
  - [**3、更新文档**](#3更新文档)
  - [**4、查询文档**](#4查询文档)
- [**六、用户管理（权限控制）**](#六用户管理权限控制)
  - [**1、权限概述**](#1权限概述)
  - [**2、创建超级管理员**](#2创建超级管理员)
    - [**（1）创建超级管理员**](#1创建超级管理员)
    - [**（2）修改 Mongodb 数据库配置文件**](#2修改-mongodb-数据库配置文件)
    - [**（3）重启 mongodb 服务**](#3重启-mongodb-服务)
    - [**（4）超级管理员账户连接数据库**](#4超级管理员账户连接数据库)
  - [**3、给PHP库创建一个普通管理员**](#3给php库创建一个普通管理员)
  - [**4、Mongodb 账户权限配置中常用的命令**](#4mongodb-账户权限配置中常用的命令)
  - [**5、Mongodb 数据库角色**](#5mongodb-数据库角色)
- [**七、Mongodb 中索引**](#七mongodb-中索引)
  - [**1、普通单列索引**](#1普通单列索引)
  - [**2、多列索引（复合索引）**](#2多列索引复合索引)
  - [**3、子文档索引**](#3子文档索引)
  - [**4、唯一索引**](#4唯一索引)
  - [**5、查看索引**](#5查看索引)
  - [**6、删除索引**](#6删除索引)
  - [**7、重建索引**](#7重建索引)
  - [**8、索引使用注意事项**](#8索引使用注意事项)
- [**八、Mongodb 中数据导出与导入**](#八mongodb-中数据导出与导入)
    - [**（1）导出数据**](#1导出数据)
    - [**（2）导入数据**](#2导入数据)
- [**九、主从复制(读写分离)**](#九主从复制读写分离)
  - [**1、原理图：**](#1原理图)
  - [**2、实现的注意点；**](#2实现的注意点)
  - [**3、配置步骤：**](#3配置步骤)
- [**十、php操作mongodb**](#十php操作mongodb)
  - [**1、安装扩展**](#1安装扩展)
  - [**2、入门使用**](#2入门使用)
    - [**（1）插入数据**](#1插入数据)
    - [**（2）查询数据**](#2查询数据)
    - [**（3）更新数据**](#3更新数据)



# <a name="_toc484877583"></a><a name="_toc531708785"></a>**一、mongodb的认识**
## <a name="_toc451356797"></a><a name="_toc476842568"></a><a name="_toc484877584"></a><a name="_toc531708786"></a>**1、基本简介**
MongoDB 是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的，语法有点类似javascript面向对象的查询语言，它是一个面向集合的，模式自由的文档型数据库。实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。它的特点是高性能、易部署、易使用，存储数据非常方便
## <a name="_toc451356798"></a><a name="_toc476842569"></a><a name="_toc484877585"></a><a name="_toc531708787"></a>**2、mongodb与 mysql性能比较**
前提；分别插入100万条记录，并对其做100个用户并发查询操作，

![QQ截图20130308135204](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.002.png "QQ截图20130308135204")
## <a name="_toc451356799"></a><a name="_toc476842570"></a><a name="_toc484877586"></a><a name="_toc531708788"></a>**3、应用范围和限制**
缺点:不支持连表查询，不支持sql语句，不支持事务存储过程等，所以不适合存储数据间关系比较复杂的数据，一般主要是当做一个**数据仓库**来使用。

**适用于**：日志系统，股票数据等。

**不适用于**：电子商务系统等需要连多表查询的功能。
# <a name="_toc451356800"></a><a name="_toc476842571"></a><a name="_toc484877587"></a><a name="_toc531708789"></a>**二、需要掌握的几个概念**
## <a name="_toc451356801"></a><a name="_toc476842572"></a><a name="_toc484877588"></a><a name="_toc531708790"></a>**1、文档**
**文档**是mongoDB中数据的**基本单元**，类似关系数据库的行， 

多个键值对有序地放置在一起便是文档。

` `MongoDB 中以文档的方式存取记录，如一条记录格式如下： 



{ “username”:”Tom”, “age”:10 ,email:’xiaobai@sohu.com’,’sex’:男，键,值}

{ "username":"Tom" , "age" : "10" } 

{“Username”:”Tom”,”age”:10} 

{“Username”:”Tom” } 

注意：

（1）以上是几个不同的文档，**MongoDB区分大小写的数据类型**，第一个age字段是**数字**类型，第二个age是**字符串**类型。

（2）每一个文档尺寸不能超过**16M** 

## <a name="_toc451356802"></a><a name="_toc476842573"></a><a name="_toc484877589"></a><a name="_toc531708791"></a>**2、集合**
集合就是一组文档，**多个文档组成一个集合**，集合类似于 mysql里面的表 。

**无模式**是指，在**同一个集合**中可以包含**不同格式的文档**，如：

{   "Name" : "Mongodb" ,  "Type" : "Nosql"  }

{   "UserName" : "Tom"  ,  "age"  :  20  ,  "Gender"  :  "male"  }

以上两个文档可以放在同一个集合中。

在Mysql需要先建表再插入数据， 

**模式自由**（schema-free）：**意思是集合里面没有行和列的概念**， 

注意：MongoDB中的**集合不用创建**、**没有结构**，所以可以放不同格式的文档。
## <a name="_toc451356803"></a><a name="_toc476842574"></a><a name="_toc484877590"></a><a name="_toc531708792"></a>**3、数据库**
多个集合可以组成数据库。一个mongoDB实例可以承载多个数据库，他们之间完全独立。 

Mongodb中的数据库和Mysql中的数据库概念类似，只是**无需创建**。

一个数据库中可以有多个集合。

一个集合中可以有多个文档。
## <a name="_toc451356804"></a><a name="_toc476842575"></a><a name="_toc484877591"></a><a name="_toc531708793"></a>**4、mongodb的数据体系**
![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.003.png)

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.004.png)

# <a name="_toc451356805"></a><a name="_toc476842576"></a><a name="_toc484877592"></a><a name="_toc531708794"></a>**三、安装mongodb**
下载软件

下载地址: https://www.mongodb.com/download-center/community

（1）双击 MongoDB 软件下一步下一步安装

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.005.png)

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.006.png)

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.007.png)

安装完成后，可以通过服务方式启动

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.008.png)

安装完毕后，bin目录里面的常用指令；

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.009.png)

安装完毕后把mongodb的安装路径，配置成环境变量

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.010.png)

如果使用解压包的安装使用

（1）解压后，拷贝到一个指定目录；

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.011.png)

（2）新建一个文件夹和一个文件

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.012.png)

（3）进入bin目录，启动mongod文件；

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.013.png)

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.014.png)

查看端口，如果有27017则启动成功；

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.015.png)



# <a name="_toc451356814"></a><a name="_toc476842585"></a><a name="_toc484877601"></a><a name="_toc531708795"></a>**四、入门语句**
## <a name="_toc451356815"></a><a name="_toc476842586"></a><a name="_toc484877602"></a><a name="_toc531708796"></a>**1、创建数据库**
语法： use  数据库名称

注意：**如果该数据库不存在，则创建，如果该数据库存在，则是切换，如果创建了数据库**，没有任何的操作，则会自动删除该数据库。

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.016.png)
## <a name="_toc451356816"></a><a name="_toc476842587"></a><a name="_toc484877603"></a><a name="_toc531708797"></a>**2、查看数据库，**
语法：show dbs

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.017.png)
## <a name="_toc451356817"></a><a name="_toc476842588"></a><a name="_toc484877604"></a><a name="_toc531708798"></a>**3、创建集合**
注意：mongodb里面的集合是隐式创建，就是无需创建，直接使用。

语法：db.集合名.insert({})该语法意思是，向集合里面，添加文档。

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.018.png)
## <a name="_toc451356818"></a><a name="_toc476842589"></a><a name="_toc484877605"></a><a name="_toc531708799"></a>**4、查看集合**
语法：show tables

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.019.png)

## <a name="_toc451356819"></a><a name="_toc476842590"></a><a name="_toc484877606"></a><a name="_toc531708800"></a>**5、查询集合里面的文档**
语法：

db.集合名.find()  查询所有

db.集合名.findOne()   查询第一个文档

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.020.png)
## <a name="_toc451356820"></a><a name="_toc476842591"></a><a name="_toc484877607"></a><a name="_toc531708801"></a>**6、删除集合**
语法：db.集合名.drop();

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.021.png)
## <a name="_toc451356821"></a><a name="_toc476842592"></a><a name="_toc484877608"></a><a name="_toc531708802"></a>**7、删除数据库**
语法：

use  数据库

db.dropDatabase()

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.022.png)
## <a name="_toc451356822"></a><a name="_toc476842593"></a><a name="_toc484877609"></a><a name="_toc531708803"></a>**8、帮助命令**
全局帮助命令

语法：help

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.023.png)

数据库相关的帮助命令

语法：db.help()

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.024.png)

集合相关的帮助命令

语法：db.集合名.help() 

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.025.png)
# <a name="_toc451356823"></a><a name="_toc476842594"></a><a name="_toc484877610"></a><a name="_toc531708804"></a>**五、增删改查操作**
## <a name="_toc451356824"></a><a name="_toc476842595"></a><a name="_toc484877611"></a><a name="_toc531708805"></a>**1、添加文档**
语法： db.集合名.insert({k1:’v1’,k2:’v2’…..})

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.026.png)

注意点：

（1）文档就是键值对，数据类型是BSON格式，支持的值更加丰富。

比如：db.集合名.insert({name:’xiaobai’,spc:{weight:100,address:’guangzhou’}})

（2）在添加的文档里面，都有一个’\_id’的键，值为对象类型。

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.027.png)

ObjectId类型： 

每个文档都有一个\_id字段，并且**同一集合**中的\_id**值唯一**，该字段可

以是**任意类型**的数据，默认是一个**ObjectId对象**。

**ObjectId对象**对象数据组成：**时间戳 |机器码|PID|计数器** 

\_id的键值我们可以自己输入，但是不能重复

注意：在插入数据的时候，如果\_id的值重复则会报错。

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.028.png)

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.029.png)

（3）可以使用js代码来完成批量插入文档。

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.030.png)
## <a name="_toc451356825"></a><a name="_toc476842596"></a><a name="_toc484877612"></a><a name="_toc531708806"></a>**2、删除文档**
语法：db.集合名.remove({条件})（不写条件删除所有的文档） 

例1：删除 php 集合中年龄等于5的文档 

db.user.remove({age:5})

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.031.png)

例2：删除 php集合中年龄大于8的文档 

使用操作符来完成

**常用操作符:**

$lt , $lte , $gt , $gte   ( < , <= , > , >= ), $ne ( <> ) ,$in , $nin ,  $or ,  $not,  

$mod (取模),  $exists, $where 

db.php.remove({age:{‘$gt’:8}})

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.032.png)
## <a name="_toc451356826"></a><a name="_toc476842597"></a><a name="_toc484877613"></a><a name="_toc531708807"></a>**3、更新文档**
**方法一，直接修改**

语法：db.集合名.update({条件},**{新的文档},**是否新增,是否修改多条)

语法： db.集合.update(条件，新文档, 是否新增, 是否修改多条)

**是否新增**：如果值是1（true）则没有满足条件的则添加。

**是否修改多条**：若值是1（true），如果满足条件的有多个文档则都要修改，

案例1：在php集合里面，要修改age=4的文档名称为xiaosi

db.php.update({age:4},{name:’xiaosi’})

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.033.png)

注意；以上修改方式，会丢失其他的键值，因此不推荐使用。

**方法二，使用修改器**

案例2：要修改age=3的文档名称为xiaosan,并且其他键值不能丢失

**使用修改器**

$inc : 加一个数字

**$set : 修改某一个字段,如果该字段不存在就增这个字段**

**语法：db.集合名.update({条件},{修改器名称:{修改的键:修改的新值}})**

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.034.png)

**db.user.update({age:3},{'$set':{name:'xiaosan'}})**

案例3：要修改age=1的文档的年龄添加10岁

**语法：db.集合名.update({条件},{修改器名称:{修改的键:修改的新值}})**

db.user.update({age:1},{'$inc':{age:10}})

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.035.png)
## <a name="_toc451356827"></a><a name="_toc476842598"></a><a name="_toc484877614"></a><a name="_toc531708808"></a>**4、查询文档**
语法：db.集合名.find({条件})

案例1：取出php集合里面第一个文档

db.user.findOne();

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.036.png)

案例2：取出php集合里面age=2的文档

db.user.find({age:2})

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.037.png)

案例3：取出php集合里面age大于2的文档

db.user.find({age:{‘$gt’:2}})

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.038.png)

案例4：取出php集合里面的文档，只显示name键

db.user.find({},{name:1})//1表示只显示name键值

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.039.png)

注意：db.php.find({},{age:0})//0表示除了age键值，其他的都显示。

案例5：根据年龄的（降序|升序）来显示文档

db.集合名.find().sort({age:1})根据年龄升序 

db.集合名.find().sort({age:-1})根据年龄降序

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.040.png)

案例6：显示php集合中前3个文档。

db.user.find().limit(3)

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.041.png)

案例7：显示php集合中第3个文档到第5个文档。

db.user.find().skip(2).limit(5)       相当于  mysql里面的    limit  offset   number

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.042.png)

案例8：统计php集合中文档的个数

db.集合名.count()：返回集合中有多少个文档。

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.043.png)
# <a name="_toc451356828"></a><a name="_toc476842599"></a><a name="_toc484877615"></a><a name="_toc531708809"></a>**六、用户管理（权限控制）**
## <a name="_toc451356829"></a><a name="_toc476842600"></a><a name="_toc484877616"></a><a name="_toc531708810"></a>**1、权限概述**
在mongodb里面的用户是属于数据库的,每个数据库有自己的管理员，管理员登录后，只能操作所属的数据库。

注意：一般在admin数据库中创建的用户授予超级管理员权限，登录后可以操作任何的数据库。

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.044.png)
## <a name="_toc451356830"></a><a name="_toc476842601"></a><a name="_toc484877617"></a><a name="_toc531708811"></a>**2、创建超级管理员**
注意：在开启权限管理控制时，一定先要创建一个超级管理员授予超级管理权限。
### <a name="_toc531708812"></a>**（1）创建超级管理员**
登录mongodb的客户端，使用如下命令

use  admin

db.createUser({ user:'root', pwd:'123456', roles:[{role:'root',db:'admin'}] })


![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.045.png)
### <a name="_toc531708813"></a>**（2）修改 Mongodb 数据库配置文件**
E:\Program Files\MongoDB\Server\4.0\bin

security:

`  `authorization: enabled

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.046.png)
### <a name="_toc531708814"></a>**（3）重启 mongodb 服务**
![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.047.png)

### <a name="_toc531708815"></a>**（4）超级管理员账户连接数据库**
如果没有输入密码，进入 MongoDB的客户端，进行操作，会报如下错误提示；

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.048.png)

本地连接：

mongo 数据库名称  -u 用户名 -p 密码 

mongo  admin -u 用户名 -p 密码 

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.049.png)

远程连接：mongo IP地址:端口/数据库名称 -u 用户名 -p 密码
## <a name="_toc531708816"></a>**3、给PHP库创建一个普通管理员**
use php

db.createUser( { user: "phpadmin", pwd: "123456", roles: [ { role: "dbOwner", db: "php" } ] } )

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.050.png)

登录操作

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.051.png)
## <a name="_toc531708817"></a>**4、Mongodb 账户权限配置中常用的命令**
（1）show users; #查看当前库下的用户

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.052.png)

（2）db.dropUser("eggadmin") #删除用户

（3）db.updateUser( "admin",{pwd:"password"}); #修改用户密码

（4）db.auth("admin","password"); #密码认证

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.053.png)
## <a name="_toc531708818"></a>**5、Mongodb 数据库角色**
（1）数据库用户角色：read、readWrite; 

（2）数据库管理角色：dbAdmin、**dbOwner**、userAdmin； 

（3）集群管理角色：clusterAdmin、clusterManager、clusterMonitor、hostManager； 

（4）备份恢复角色：backup、restore； 

（5）所有数据库角色：readAnyDatabase、readWriteAnyDatabase、userAdminAnyDatabase、 dbAdminAnyDatabase 

（6）超级用户角色：**root**



# <a name="_toc451356834"></a><a name="_toc476842605"></a><a name="_toc484877621"></a><a name="_toc531708819"></a>**七、Mongodb 中索引** 
索引是对数据库表中一列或多列的值进行排序的一种结构，可以让我们查询数据库变得 更快。MongoDB 的索引几乎与传统的关系型数据库一模一样，这其中也包括一些基本的查 询优化技巧。
## <a name="_toc451356835"></a><a name="_toc476842606"></a><a name="_toc484877622"></a><a name="_toc531708820"></a>**1、普通单列索引** 
测试代码：

\> for(var i=0;i<200000;i++){ 

... db.java.insert({name:'xiao'+i,age:i}) 

... } 

**第一**：先检验一下查询性能

var start = new Date()

db.java.find({name:'xiao191789'}) 

var end = new Date() 

end-start

**第二**：为name创建索引

db.集合名.ensureIndex({name:1}) 

**第三**：再执行第一部分代码可以看出有数量级的性能提升 

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.054.png)

语法：

db.集合名.ensureIndex({键名：1}) 1是升续 -1是降续

## <a name="_toc451356836"></a><a name="_toc476842607"></a><a name="_toc484877623"></a><a name="_toc531708821"></a>**2、多列索引（复合索引）**


创建多列索引 

db.集合名.ensureIndex({field1:1/-1, field2:1/-1});

对name和age 建立一个复合索引

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.055.png)

可以使用db.集合名.getIndexes()查看创建的索引情况。

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.056.png)

该索引被创建后，基于 username 和 age 的查询将会用到该索引，或者是基于 username 的查询也会用到该索引，但是只是基于 age 的查询将不会用到该复合索引。因此可以说， 如果想用到复合索引，必须在查询条件中包含复合索引中的前 N 个索引列。
## <a name="_toc451356837"></a><a name="_toc476842608"></a><a name="_toc484877624"></a><a name="_toc531708822"></a>**3、子文档索引**
语法：

db.集合名.ensureIndex({filed.subfield:1/-1});

如下文档可以建立子文档索引

{name:’诺基亚手机1’,price:12.34,spc:{weight:100,area:’纽约’}}

{name:’诺基亚手机2’,price:42.34,spc:{weight:200,area:’伦敦’}}

比如要查询weight等于100的文档。

db.goods.find({‘spc.weight’:100})

根据当前案例，我们建立子文档索引

db.集合名.ensureIndex({'spc.w':1})

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.057.png)

## <a name="_toc451356838"></a><a name="_toc476842609"></a><a name="_toc484877625"></a><a name="_toc531708823"></a>**4、唯一索引** 
语法：

db.集合名.ensureIndex({name:-1},{unique:true}) 

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.058.png)

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.059.png)
## <a name="_toc451356840"></a><a name="_toc476842611"></a><a name="_toc484877626"></a><a name="_toc531708824"></a>**5、查看索引**
常用命令: 

（1）查看当前索引状态: db.集合名.getIndexes(); 

（2）详情查看本次查询使用哪个索引和查询数据的状态信息。

explain executionStats 查询具体的执行 时间

db.tablename.find().explain( "executionStats" ) 

关注输出的如下数值：explain.executionStats.executionTimeMillis

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.060.png)

有索引时，查询时间；

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.061.png)

删除索引时查询时间

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.062.png)
## <a name="_toc451356841"></a><a name="_toc476842612"></a><a name="_toc484877627"></a><a name="_toc531708825"></a>**6、删除索引** 
删除单个索引

db.集合名.dropIndex({filed:1/-1});

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.063.png)

删除所有索引

db.集合名.dropIndexes();

注意：在删除所有的索引时，主键索引会保留。

## <a name="_toc451356842"></a><a name="_toc476842613"></a><a name="_toc484877628"></a><a name="_toc531708826"></a>**7、重建索引** 
一个表经过很多次修改后,导致表的文件产生空洞,索引文件也如此. 

可以通过索引的重建,减少索引文件碎片,并提高索引的效率. 

类似mysql中的optimize table 

mysql里面使用optimize table语法：optimize table 表名

语法：db.集合名.reIndex() 


## <a name="_toc451356843"></a><a name="_toc476842614"></a><a name="_toc484877629"></a><a name="_toc531708827"></a>**8、索引使用注意事项** 
（1）创建索引的时候，注意1是正序创建索引  -1是倒叙创建索引

（2）索引的创建在提高查询性能的同时会影响插入性能，对于经常查询少插入的文档可以考虑用索引

（3）复合索引要注意索引的先后顺序。 

（4）每个键全建立索引不一定就能提高性能，索引不是万能的。

（5）在做排序工作的时候如果是超大数据量也可以考虑加上索引用来提高排序的性能。
# <a name="_toc451356844"></a><a name="_toc476842615"></a><a name="_toc484877630"></a><a name="_toc531708828"></a>**八、Mongodb 中数据导出与导入** 
### <a name="_toc451356845"></a><a name="_toc476842616"></a><a name="_toc484877631"></a><a name="_toc531708829"></a>**（1）导出数据**
导入/导出可以操作的是本地的mongodb服务器，也可以是远程的，所以，都有如下通用选项。

利用**mongoexport** 

-h host主机

--port 端口

-d 指明使用的库

-c 指明要导出的集合

-o 指明要导出的文件名

--csv指定导出的csv格式

-q 过滤导出

-f field1 field2  列名

-u username 用户名

-p password 密码

如下操作，

**注意：如果端口是默认的可以不使用--port来指定端口。**

比如我们要导出php库下面的Java集合，

E:\Program Files\MongoDB\Server\4.0\bin>mongoexport -h localhost -d php -c java -o e:/nihao.json -u phpadmin -p 123456

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.064.png)

导出文件内容如下

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.065.png)
### <a name="_toc451356846"></a><a name="_toc476842617"></a><a name="_toc484877632"></a><a name="_toc531708830"></a>**（2）导入数据**
使用mongoimport命令

-d 待导入的数据库

-c 待导入的集合（不存在会自己创建）

--type csv/json(默认) 

--file 备份文件名称包含路径

例1: 导入json 

./bin/mongoimport  -h  --port  端口号  -d test -c goods --file ./goodsall.json   

例2: 导入csv 

./bin/mongoimport -h  --port  端口号 -d test -c goods --type csv -f goods\_id,goods\_name --file ./goodsall.csv 

./bin/mongoimport -h  --port  端口号 -d test -c goods --type csv --headline -f goods\_id,goods\_name --file ./goodsall.csv

案例：把刚才导出的nihao.json文件导入到php库里面的user集合里面。

E:\Program Files\MongoDB\Server\4.0\bin>mongoimport -h localhost -d php -c nihao --file e:/nihao.json -u phpadmin -p 123456

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.066.png)

导入成功，进行查看

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.067.png)

# <a name="_toc451356847"></a><a name="_toc476842618"></a><a name="_toc484877633"></a><a name="_toc531708831"></a>**九、主从复制(读写分离)**
主从复制是一个简单的数据库同步备份的集群技术。
## <a name="_toc476842619"></a><a name="_toc484877634"></a><a name="_toc531708832"></a>**1、原理图：**
## <a name="_toc451356848"></a><a name="_toc476842620"></a><a name="_toc484877635"></a><a name="_toc531708833"></a>**2、实现的注意点；**
（1）在数据库集群中要明确的知道谁是主服务器，主服务器只有一台。

（2）从服务器要知道自己的数据源也就是对于的主服务是谁。

**（3）--master用来确定主服务器，--slave和--source来控制从服务器。**
## <a name="_toc451356849"></a><a name="_toc476842621"></a><a name="_toc484877636"></a><a name="_toc531708834"></a>**3、配置步骤：**
可以通过不同端口来模拟多台mongodb服务器。

配置原理：

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.068.png)

具体的配置步骤

（1）启动主服务器

--port --dbpath –logpath --master

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.069.png)

（2）启动从服务器

--port –dbpath –logpath –slave –source 127.0.0.1:1111

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.070.png)

（3）客户端登陆到主服务器

添加一些数据，测试是否同步到从服务器

如下在主服务器里面，添加了一些文档

第一步：客户端登录到主服务器，添加一些文档

mongo localhost:1111

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.071.png)

第二步：登陆到从服务器，查看是否有数据

mongo localhost:2222

如果有数据，则成功了

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.072.png)
# <a name="_toc451356851"></a><a name="_toc476842622"></a><a name="_toc484877637"></a><a name="_toc531708835"></a>**十、php操作mongodb**
https://pecl.php.net/package/mongodb/1.2.9/windows
## <a name="_toc451356852"></a><a name="_toc476842623"></a><a name="_toc484877638"></a><a name="_toc531708836"></a>**1、安装扩展**
注意：扩展文件

下载合适的php\_mongodb.dll文件。 

（1）php的版本 

（2）是否是线程安全的thread safe(ts)

（3）是vc几的 

（4）php是32位的还是64位的。

步骤：

（1）把对应的扩展，拷贝到php的安装目录里面的ext目录里面。

注意：拷贝后，改名为php\_mongo.dll

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.073.png)

（2）打开php.ini文件，引入该扩展，

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.074.png)

（3）重启apache,

使用phpinfo()函数测试

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.075.png)
## <a name="_toc451356853"></a><a name="_toc476842624"></a><a name="_toc484877639"></a><a name="_toc531708837"></a>**2、入门使用**
PHP7 里面使用如下库，操作比较复杂；

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.076.png)
### <a name="_toc531708838"></a>**（1）插入数据**
$manager = new MongoDB\Driver\Manager("mongodb://phpadmin:123456@localhost:27017/php");

//插入数据

//创建一个对象

**$bulk = new MongoDB\Driver\BulkWrite;**

$bulk->insert(['name'=>'刘备','age'=>12,'email'=>'liubei@sohu.com']);

$bulk->insert(['name'=>'关羽','age'=>22,'email'=>'guanyu@sohu.com']);

$bulk->insert(['name'=>'张飞','age'=>18,'email'=>'zhangfei@sohu.com']);

$manager->executeBulkWrite('php.stu', $bulk);

echo 'ok';
### <a name="_toc531708839"></a>**（2）查询数据**
$filter = ['age'=>['$gt'=>16]];

$options = [

`	`'projection'=>['\_id'=>0],

`	`'sort'=>['age'=>1]

];

**$query = new MongoDB\Driver\Query($filter, $options);**

//$query = new MongoDB\Driver\Query([],[]);

$data = $manager->executeQuery('php.stu', $query);

echo '<pre>';

foreach ($data as $key => $value) {

`	`print\_r($value);

}

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.077.png)
### <a name="_toc531708840"></a>**（3）更新数据**
$bulk = new MongoDB\Driver\BulkWrite;

$bulk->update(

`    `['age' => 12],

`    `['$set' => ['name' => '刘备被', 'email' => 'liubeibei@sohu.com']],

`    `['multi' => false, 'upsert' => false]

);

$writeConcern = new MongoDB\Driver\WriteConcern(MongoDB\Driver\WriteConcern::MAJORITY, 1000);

$result = $manager->executeBulkWrite('php.stu', $bulk, $writeConcern);

echo 'ok';

（4）删除数据

$bulk = new MongoDB\Driver\BulkWrite;

$bulk->delete(['age' => 22], ['limit' => 1]);   // limit 为 1 时，删除第一条匹配数据

//$bulk->delete(['x' => 2], ['limit' => 0]);   // limit 为 0 时，删除所有匹配数据

$writeConcern = new MongoDB\Driver\WriteConcern(MongoDB\Driver\WriteConcern::MAJORITY, 1000);

$result = $manager->executeBulkWrite('php.stu', $bulk, $writeConcern);

var\_dump($result);

linux系统安装mongodb

解压后，直接进入目录启动即可；在启动时要添加--fork参数，作为一个进程后台运行；

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.078.png)

启动的命令；

![](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.079.png)
![黑马word模板页脚-20](Aspose.Words.1a0bf1c1-8f66-45b3-aa3f-ca7837936eb7.080.jpeg "黑马word模板页脚-20")北京市昌平区建材城西路金燕龙办公楼一层   电话：400-618-9090
